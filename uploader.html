<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Uploader</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #36393f;
            color: #dcddde;
        }
        .container {
            background-color: #2f3136;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        h1 {
            color: #ffffff;
            margin-top: 0;
        }
        p {
            color: #b9bbbe;
        }
        .upload-area {
            border: 2px dashed #4f545c;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 1.5rem;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .upload-area:hover {
            border-color: #7289da;
            background-color: #3a3d42;
        }
        .upload-area.drag-over {
            border-color: #7289da;
            background-color: #3a3d42;
        }
        #file-input {
            display: none;
        }
        #upload-button {
            background-color: #7289da;
            color: #ffffff;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
            transition: background-color 0.2s;
        }
        #upload-button:disabled {
            background-color: #4f545c;
            cursor: not-allowed;
        }
        #upload-button:hover:not(:disabled) {
            background-color: #677bc4;
        }
        #status {
            margin-top: 1.5rem;
            font-weight: bold;
        }
        .status-success {
            color: #43b581;
        }
        .status-error {
            color: #f04747;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #7289da;
            margin: 1rem auto 0;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Upload Your Image</h1>
        <p>Select your JPEG or WebP file to extract metadata.</p>

        <!-- Info Notice -->
        <div style="background-color: #5865f2; color: #fff; padding: 0.75rem; border-radius: 5px; margin: 1rem 0; font-size: 0.9rem;">
            üì§ Upload your original image here<br>
            üîé Bot will extract and post metadata to Discord<br>
            üóëÔ∏è Files auto-deleted after processing
        </div>

        <!-- Support Links -->
        <div style="background-color: #2f3136; padding: 0.75rem; border-radius: 5px; margin: 1rem 0; font-size: 0.85rem; border: 1px solid #4f545c;">
            <strong>üí∞ Want unlimited uploads?</strong><br>
            <a href="https://ko-fi.com/OTNAngel/" target="_blank" style="color: #7289da;">Support on Ko-fi</a> to get 500 uploads/day!<br><br>
            <strong>üíñ General support:</strong><br>
            <a href="https://ko-fi.com/duskfallcrew/" target="_blank" style="color: #7289da;">Ko-fi</a> ‚Ä¢
            <a href="https://duskfallcrew-shop.fourthwall.com/" target="_blank" style="color: #7289da;">Shop</a><br><br>
            <strong>‚ùì Need help?</strong><br>
            <a href="https://discord.gg/HhBSvM9gBY" target="_blank" style="color: #7289da;">Join our Discord</a>
        </div>

        <div class="upload-area" id="upload-area">
            <p id="upload-text">Click or drag & drop up to 10 files here</p>
            <p style="font-size: 0.8rem; color: #72767d; margin-top: 0.5rem;">JPEG/WebP only ‚Ä¢ Max 10MB each ‚Ä¢ Up to 10 files</p>
        </div>

        <button id="upload-button" disabled>Upload All</button>

        <div id="status"></div>
        <div id="file-list" style="margin-top: 1rem; font-size: 0.9rem;"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'file-input';
        fileInput.accept = 'image/jpeg,image/webp'; // Only JPEG/WebP for metadata preservation
        fileInput.multiple = true; // Allow multiple file selection
        document.body.appendChild(fileInput);

        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB limit
        const MAX_FILES = 10; // Max 10 files

        const uploadButton = document.getElementById('upload-button');
        const statusDiv = document.getElementById('status');
        const uploadText = document.getElementById('upload-text');
        const fileListDiv = document.getElementById('file-list');

        let selectedFiles = [];

        // --- Event Listeners ---
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        uploadButton.addEventListener('click', handleUpload);

        // Drag and drop listeners
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect({ target: fileInput });
            }
        });


        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = [];
            fileListDiv.innerHTML = '';

            if (files.length === 0) {
                uploadText.textContent = 'Click or drag & drop up to 10 files here';
                uploadButton.disabled = true;
                return;
            }

            // Check file count
            if (files.length > MAX_FILES) {
                showStatus(`‚ùå Too many files! Maximum is ${MAX_FILES} files.`, 'error');
                uploadButton.disabled = true;
                uploadText.textContent = 'Click or drag & drop up to 10 files here';
                return;
            }

            // Validate each file
            let allValid = true;
            const fileListHTML = [];

            for (const file of files) {
                // Validate file type
                const validTypes = ['image/jpeg', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    showStatus(`‚ùå Invalid file type for ${file.name}. Only JPEG and WebP files are supported.', 'error');
                    allValid = false;
                    break;
                }

                // Validate file size (10MB max)
                if (file.size > MAX_FILE_SIZE) {
                    const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                    showStatus(`‚ùå File too large: ${file.name} (${sizeMB}MB). Maximum size is 10MB.`, 'error');
                    allValid = false;
                    break;
                }

                // File is valid
                selectedFiles.push(file);
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                fileListHTML.push(`<div style="color: #b9bbbe; padding: 0.25rem 0;">‚úì ${file.name} (${sizeMB}MB)</div>`);
            }

            if (allValid && selectedFiles.length > 0) {
                uploadText.textContent = `Selected ${selectedFiles.length} file(s)`;
                fileListDiv.innerHTML = fileListHTML.join('');
                uploadButton.disabled = false;
                statusDiv.innerHTML = '';
            } else {
                selectedFiles = [];
                uploadText.textContent = 'Click or drag & drop up to 10 files here';
                uploadButton.disabled = true;
            }
        }

        async function handleUpload() {
            if (selectedFiles.length === 0) {
                showStatus('Please select at least one file first.', 'error');
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const uploadUrlsParam = params.get('upload_urls');

            if (!uploadUrlsParam) {
                showStatus('Error: No upload URLs provided. Please use the link from the bot again.', 'error');
                return;
            }

            let uploadUrls;
            try {
                uploadUrls = JSON.parse(decodeURIComponent(uploadUrlsParam));
            } catch (e) {
                showStatus('Error: Invalid upload URLs. Please use the link from the bot again.', 'error');
                return;
            }

            if (selectedFiles.length > uploadUrls.length) {
                showStatus(`Error: Too many files selected. Maximum is ${uploadUrls.length}.`, 'error');
                return;
            }

            setUploadingState(true);

            let successCount = 0;
            let failCount = 0;
            const results = [];

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const uploadUrl = uploadUrls[i];

                try {
                    statusDiv.innerHTML = `<div class="spinner"></div><p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name}...</p>`;

                    const response = await fetch(uploadUrl, {
                        method: 'PUT',
                        body: file,
                        headers: {
                            'Content-Type': file.type || 'application/octet-stream'
                        }
                    });

                    if (response.ok) {
                        successCount++;
                        results.push(`‚úÖ ${file.name}`);
                    } else {
                        failCount++;
                        results.push(`‚ùå ${file.name} (Error ${response.status})`);
                        console.error(`Upload failed for ${file.name}:`, response.status);
                    }
                } catch (error) {
                    failCount++;
                    results.push(`‚ùå ${file.name} (Network error)`);
                    console.error(`Network error for ${file.name}:`, error);
                }
            }

            setUploadingState(false);

            // Show final status
            const resultHTML = results.map(r => `<div style="margin: 0.25rem 0;">${r}</div>`).join('');
            if (failCount === 0) {
                showStatus(`‚úÖ Success! All ${successCount} file(s) uploaded. Go back to Discord and click "Process Uploaded Images".`, 'success');
                fileListDiv.innerHTML = resultHTML;
                uploadButton.disabled = true;
            } else {
                showStatus(`‚ö†Ô∏è Completed with errors: ${successCount} succeeded, ${failCount} failed.`, 'error');
                fileListDiv.innerHTML = resultHTML;
            }
        }
        
        function setUploadingState(isUploading) {
            uploadButton.disabled = isUploading;
            if (isUploading) {
                statusDiv.innerHTML = '<div class="spinner"></div><p>Uploading...</p>';
            }
        }

        function showStatus(message, type) {
            statusDiv.innerHTML = `<p class="status-${type}">${message}</p>`;
        }

    </script>
</body>
</html>
